jQuery((function(e){if("undefined"==typeof LedyerPaymentsParams)return!1;const r={params:LedyerPaymentsParams,gatewayId:LedyerPaymentsParams.gatewayId,sessionId:LedyerPaymentsParams.sessionId,i18n:{},init:()=>{e("body").on("click","input#place_order, button#place_order",(t=>{try{if(!r.isActiveGateway())return;if(0===e("#billing_company_number").val().trim().length)return r.printNotice(r.params.i18n.companyNumberMissing),!1;r.submitOrder(t)}catch(o){return r.printNotice(r.params.i18n.genericError),console.error(o),!1}})),e(document).ready((()=>{"billing_form"===r.params.companyNumberPlacement&&(r.isActiveGateway()&&e("#billing_company_number_field").remove(),e("body").on("change",'input[name="payment_method"]',r.moveCompanyNumberField),e("body").on("updated_checkout",r.moveCompanyNumberField)),r.toggleCheckoutField(),e("body").on("change",'input[name="payment_method"]',r.toggleCheckoutField),e("body").on("updated_checkout",r.toggleCheckoutField)}))},moveCompanyNumberField:()=>{"billing_form"===r.params.companyNumberPlacement&&(r.isActiveGateway()?e("#billing_company_number_field").detach().insertAfter("#billing_company_field").show():e("#billing_company_number_field").hide())},toggleCheckoutField:()=>{r.isActiveGateway()?r.makeCheckoutFieldRequired("billing_company_field"):r.makeCheckoutFieldOptional("billing_company_field",!1)},makeCheckoutFieldRequired:t=>{const o=r.i18n.required??e(".required").first().text();if(0===o.length)return!1;r.i18n.required=o;const a=e(`#${t}`),n=a.find("input").first();if("true"===n.attr("aria-required")||"true"===n.attr("required"))return!1;a.attr("data-optional","true"),n.attr("aria-required","true"),n.attr("required","true");const i=a.find("label").first();i.find(".optional").remove();let c=e(".required").first();c=0===c.length?e.parseHTML(`<abbr class="required" title="required">${o}</abbr>`):c.clone(),i.append(c)},makeCheckoutFieldOptional:(t,o=!0)=>{const a=r.i18n.optional??e(".optional").first().text();if(0===a.length)return!1;r.i18n.optional=a;const n=e(`#${t}`);if(!n.attr("data-optional")&&!o)return!1;if(0===n.find(".required").length)return!1;const i=n.find("input").first();i.attr("aria-required","false"),i.attr("required","false");const c=n.find("label").first();c.find(".required").remove();let s=e(".optional").first();s=0===s.length?e.parseHTML(`<span class="optional">${a}</span>`):s.clone(),c.append(s)},handleProceedWithLedyer:async(e,t)=>{try{r.blockUI();const o={customer:{...t},sessionId:r.sessionId},a=await window.ledyer.payments.api.authorize(o);"authorized"===a.state?r.createOrder(a,e):"awaitingSignatory"===a.state&&r.createPendingOrder(a,e)}catch(o){console.error(o)}finally{r.unblockUI()}},printNotice:t=>{const o=`${r.gatewayId}-error-notice`;e(`#${o}`).remove();const a=`<div id='${o}' class='woocommerce-NoticeGroup'><ul class='woocommerce-error' role='alert'><li>${t}</li></ul></div>`;e("form.checkout").prepend(a),document.getElementById(o).scrollIntoView({behavior:"smooth"})},logToFile:(t,o="notice")=>{const{logToFileUrl:a,logToFileNonce:n,reference:i}=r.params;console.debug(t),e.ajax({url:a,type:"POST",dataType:"json",data:{level:o,reference:i,message:t,nonce:n}})},unblockUI:()=>{e(".woocommerce-checkout-review-order-table").unblock(),e("form.checkout").removeClass("processing").unblock()},blockUI:()=>{e(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e("form.checkout").addClass("processing"),e("form.checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},isActiveGateway:()=>{if(e('input[name="payment_method"]:checked').length){return e('input[name="payment_method"]:checked').val().indexOf(r.gatewayId)>=0}return!1},updateNonce:e=>{for(const t in e)t in r.params&&(r.params[t]=e[t])},submitOrderFail:(t,o)=>{console.debug("[%s] Woo failed to create the order. Reason: %s",t,o),r.unblockUI(),e(document.body).trigger("checkout_error"),e(document.body).trigger("update_checkout"),r.printNotice(o)},submitOrder:t=>{if(e("form.checkout").is(".processing"))return!1;t.preventDefault(),r.blockUI();const{submitOrderUrl:o}=r.params;e.ajax({type:"POST",url:o,data:e("form.checkout").serialize(),dataType:"json",success:async e=>{try{if(e.nonce&&r.updateNonce(e.nonce),"success"!==e.result)throw console.warn("AJAX request succeeded, but the Woo order was not created.",e),"SubmitOrder failed";{const{order_key:t,customer:o}=e;r.logToFile(`Successfully placed order ${t}. Sending "shouldProceed: true".`),r.handleProceedWithLedyer(t,o)}}catch(t){if(console.error(t),e.messages){const t=e.messages.replace(/<\/?[^>]+(>|$)/g,"");r.logToFile("Checkout error | "+t,"error"),r.submitOrderFail("submitOrder",t)}else r.logToFile("Checkout error | No message","error"),r.submitOrderFail("submitOrder","Checkout error")}},error:e=>{try{r.logToFile("AJAX error | "+JSON.stringify(e),"error")}catch(t){r.logToFile("AJAX error | Failed to parse error message.","error")}r.submitOrderFail("AJAX","Something went wrong, please try again.")}})},createOrder:(t,o)=>{if("authorized"!==t.state)throw new Error(`createOrder was called with an invalid state. Received ${t.state}, expected 'authorized'.`);const a=t.authorizationToken,{state:n}=t,{createOrderUrl:i,createOrderNonce:c}=r.params;e.ajax({type:"POST",url:i,dataType:"json",data:{state:n,order_key:o,auth_token:a,nonce:c},async:!1,success:e=>{if(!e.success)return void r.submitOrderFail("createOrder","The payment was successful, but the order could not be created.");const{data:{location:t}}=e;window.location=t},error:(e,t,o)=>{console.debug("Error:",t,o),console.debug("Response:",e.responseText),console.error(o),r.submitOrderFail("createOrder","The payment was successful, but the order could not be created.")}})},createPendingOrder:(t,o)=>{if("awaitingSignatory"!==t.state)throw new Error(`createPendingOrder was called with an invalid state. Received ${t.state}, expected 'awaitingSignatory'.`);const{pendingPaymentUrl:a,pendingPaymentNonce:n}=r.params;e.ajax({type:"POST",url:a,dataType:"json",data:{order_key:o,nonce:n},async:!1,success:e=>{if(!e.success)return void r.submitOrderFail("pendingPayment","The payment is pending payment. Failed to redirect to order received page.");const{data:{location:t}}=e;window.location=t},error:(e,t,o)=>{console.debug("Error:",t,o),console.debug("Response:",e.responseText),r.submitOrderFail("pendingPayment","The payment is pending payment. Failed to redirect to order received page.")}})}};r.init()}));
//# sourceMappingURL=ledyer-payments.min.js.map
